- alias: Power Outage Starts in
  description: ""
  triggers:
    - event: start
      offset: "-2:0:00"
      entity_id: calendar.kiiv_dtek_3_1_planned_outages
      trigger: calendar
      enabled: false
    - event: start
      offset: "-1:0:00"
      entity_id: calendar.kiiv_dtek_3_1_planned_outages
      trigger: calendar
    - event: start
      offset: "-0:30:00"
      entity_id: calendar.kiiv_dtek_3_1_planned_outages
      trigger: calendar
    - event: start
      offset: "-0:5:00"
      entity_id: calendar.kiiv_dtek_3_1_planned_outages
      trigger: calendar
    - event: start
      offset: "-0:0:00"
      entity_id: calendar.kiiv_dtek_3_1_planned_outages
      trigger: calendar
  conditions:
    - condition: and
      conditions:
        - condition: template
          value_template: "{{trigger.calendar_event.description == 'Definite'}}"
  actions:
    - action: tts.speak
      target:
        entity_id: tts.google_uk_com_ua
      data:
        media_player_entity_id: media_player.my_speaker
        language: ua
        message: >-
          {% set battery_level = states('sensor.delta_pro_battery_level') | default(-1) | float %}
          {% set battery_target = states('number.delta_pro_max_charge_level') | default(100) | float %}
          {% set start = trigger.calendar_event.start|as_datetime|as_local %}
          {% set start_minutes = (start - now()).seconds // 60 %}
          {% set end = trigger.calendar_event.end|as_datetime|as_local %}
          {% set duration_hours = (end - start).seconds // 60 // 60 %}
          {% set end_str = end|as_timestamp|timestamp_custom('%H:%M') %}

          Відключення електроенергії може відбутися за {{ start_minutes }} хвилин
          і продовжиться {{ duration_hours }} години до {{end_str}}.

          {% if start_minutes <= 5 -%}
            Не забудьте закип'ятити воду.
          {%- endif %}

          {% if battery_level >= 0 and battery_level < battery_target - 15 %}
            Рівень заряду екофлоу - {{battery_level | round(0) | int }} відсотків.
          {% endif %}
      enabled: true
  mode: single

- alias: "Power Outage Schedule Changed"
  trigger:
    - platform: state
      entity_id: sensor.kiiv_dtek_3_1_schedule_data_changed_on
      for:
        hours: 0
        minutes: 0
        seconds: 5
  action:
    - service: notify.mobile_app
      data:
        message: "Power outage schedule has changed!"

- alias: "Power Outage Schedule Changed"
  trigger:
    - platform: state
      entity_id: sensor.kiiv_dtek_3_1_schedule_updated_on
      attribute: last_data_change
      for:
        hours: 0
        minutes: 0
        seconds: 5
  action:
    - service: notify.mobile_app
      data:
        message: "Power outage schedule has changed!"

- alias: "Power Outage Schedule Changed - Kyiv 3.1"
  description: "Notify only when outage schedule changes for Kyiv DTEK group 3.1"
  trigger:
    - platform: event
      event_type: svitlo_yeah_data_changed
      event_data:
        provider:
          region_name: Київ
        group: '3.1'
  action:
    - service: notify.mobile_app
      data:
        message: "Kyiv Group 3.1 Schedule Changed"

- alias: "Power Outage Schedule Changed - Lviv 2.2"
  description: "Notify only when outage schedule changes for Lviv 2.2"
  trigger:
    - platform: event
      event_type: svitlo_yeah_data_changed
      event_data:
        provider:
          region_name: lviv
        group: '2.2'
  action:
    - service: notify.mobile_app
      data:
        message: "Lviv Group 2.2 Schedule Changed"
